<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="./resources/ol.css">
        <link rel="stylesheet" href="resources/fontawesome-all.min.css">
        <link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet">
        <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
        <link rel="stylesheet" href="./resources/qgis2web.css">
        <style>
        html, body {
            background-color: #ffffff;
        }
        .ol-control > * {
            background-color: #f8f8f8!important;
            color: #444444!important;
            border-radius: 0px;
        }
        .ol-attribution a, .gcd-gl-input::placeholder, .search-layer-input-search::placeholder {
            color: #444444!important;
        }
        .search-layer-input-search {
            background-color: #f8f8f8!important;
        }
        .ol-control > *:focus, .ol-control >*:hover {
            background-color: rgba(248, 248, 248, 0.7)!important;
        } 
        .ol-control {
            background-color: rgba(255,255,255,.4) !important;
            padding: 2px !important;
        } 
        </style>

        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        </style>
        <title></title>
    </head>
    <body>
        <div id="map">
            <div id="popup" class="ol-popup">
                <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                <div id="popup-content"></div>
            </div>
        </div>
        <script src="resources/qgis2web_expressions.js"></script>
        <script src="./resources/functions.js"></script>
        <script src="./resources/ol.js"></script>
        <script src="./resources/ol-layerswitcher.js"></script>
        <script src="resources/photon-geocoder-autocomplete.min.js"></script>
        <script src="layers/sedi_port_layout_1.js"></script><script src="layers/sedi_2020_2.js"></script><script src="layers/sedi_2010_3.js"></script><script src="layers/sedi_2000_4.js"></script><script src="layers/sedi_1990_5.js"></script><script src="layers/erosion_port_layout_6.js"></script><script src="layers/ero_2020_7.js"></script><script src="layers/ero_2000_8.js"></script><script src="layers/ero_2010_9.js"></script><script src="layers/ero_1990_10.js"></script>
        <script src="styles/sedi_port_layout_1_style.js"></script><script src="styles/sedi_2020_2_style.js"></script><script src="styles/sedi_2010_3_style.js"></script><script src="styles/sedi_2000_4_style.js"></script><script src="styles/sedi_1990_5_style.js"></script><script src="styles/erosion_port_layout_6_style.js"></script><script src="styles/ero_2020_7_style.js"></script><script src="styles/ero_2000_8_style.js"></script><script src="styles/ero_2010_9_style.js"></script><script src="styles/ero_1990_10_style.js"></script>
        <script src="./layers/layers.js" type="text/javascript"></script> 
        <script src="./resources/Autolinker.min.js"></script>
        <script src="./resources/qgis2web.js"></script>
        <script>
            // Listen for postMessage from parent frame (Hydrography page)
            window.addEventListener('message', function(event) {
                if (typeof map === 'undefined') return;
                
                if (event.data && event.data.type === 'setZoom') {
                    // Zoom to specific location and level
                    const zoom = event.data.zoom || 15;
                    const center = event.data.center || [31.7706, 31.4706]; // [lng, lat]
                    try {
                        // Convert from [lng, lat] to [lat, lng] for OL.map
                        map.getView().animate({
                            center: ol.proj.fromLonLat([center[0], center[1]]),
                            zoom: zoom,
                            duration: 500
                        });
                    } catch (e) {}
                }
                else if (event.data && event.data.type === 'setLayers') {
                    // Handle tab switching: show only layers for the active tab
                    const layersToShow = event.data.layers || [];
                    const tab = event.data.tab || 'erosion';
                    const allLayers = [];
                    
                    // Collect all layers from the map
                    if (map && map.getLayers && typeof map.getLayers === 'function') {
                        map.getLayers().forEach(function(layer) {
                            allLayers.push(layer);
                        });
                    }
                    
                    // Show/hide layers based on selected tab
                    allLayers.forEach(function(layer) {
                        if (!layer || !layer.get) return;
                        const layerTitle = (layer.get('title') || '').toLowerCase();
                        if (!layerTitle) return;
                        
                        let shouldShow = false;
                        
                        // Check if this layer is port layout (always show)
                        if (layerTitle.includes('port') && layerTitle.includes('layout')) {
                            shouldShow = true;
                        }
                        // For erosion tab, show erosion layers
                        else if (tab === 'erosion') {
                            if (layerTitle.includes('ero_') || layerTitle.includes('erosion')) {
                                shouldShow = true;
                            }
                        }
                        // For sedimentation tab, show sedimentation layers
                        else if (tab === 'sedimentation') {
                            if (layerTitle.includes('sedi_') || layerTitle.includes('sedimentation')) {
                                shouldShow = true;
                            }
                        }
                        
                        // Set layer visibility
                        try {
                            layer.setVisible(shouldShow);
                        } catch (e) {}
                    });
                } 
                else if (event.data && event.data.type === 'toggleLayer') {
                    // Handle individual layer selection
                    const layerName = event.data.layer;
                    const allLayers = [];
                    
                    if (layerName && map && map.getLayers && typeof map.getLayers === 'function') {
                        map.getLayers().forEach(function(layer) {
                            allLayers.push(layer);
                        });
                        
                        allLayers.forEach(function(layer) {
                            if (!layer || !layer.get) return;
                            const layerTitle = (layer.get('title') || '').toLowerCase();
                            if (layerTitle && layerTitle.includes(layerName.toLowerCase())) {
                                layer.setVisible(true);
                                try {
                                    if (typeof map.getView === 'function') {
                                        map.getView().animate({
                                            center: ol.proj.fromLonLat([31.7706, 31.4706]),
                                            zoom: 14,
                                            duration: 500
                                        });
                                    }
                                } catch (e) {}
                            }
                        });
                    }
                }
            });

            // Send layer click event to parent frame
            setTimeout(function() {
                if (typeof map === 'undefined') return;
                map.on('singleclick', function(evt) {
                    if (!map.hasFeatureAtPixel(evt.pixel)) return;
                    
                    // Get all visible layers
                    const allLayers = [];
                    if (map && map.getLayers && typeof map.getLayers === 'function') {
                        map.getLayers().forEach(function(layer) {
                            if (layer.getVisible && layer.getVisible()) {
                                allLayers.push(layer);
                            }
                        });
                    }
                    
                    // Find which layer was clicked
                    allLayers.forEach(function(layer) {
                        if (!layer || !layer.getSource) return;
                        const source = layer.getSource();
                        if (!source || typeof source.getClosestFeatureAtCoordinate !== 'function') return;
                        
                        const feature = source.getClosestFeatureAtCoordinate(evt.coordinate);
                        if (feature) {
                            const layerTitle = (layer.get('title') || '').toLowerCase();
                            // Send to parent frame
                            try {
                                window.parent.postMessage({
                                    type: 'layerClicked',
                                    layer: layerTitle
                                }, '*');
                            } catch (e) {}
                        }
                    });
                });
            }, 1000);
        </script>        
    </body>
</html>
