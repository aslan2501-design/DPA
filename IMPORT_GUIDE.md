# دليل استخدام مكوّن استيراد Excel

## نظرة عامة
مكوّن `ExcelImporter` يسمح للمستخدمين برفع ملفات Excel/CSV تحتوي على طلبات جديدة (تراكى السفن أو طلبات المخازن)، مع التحقق والمعاينة والاستيراد إلى قاعدة البيانات.

## الملفات الرئيسية

### 1. `src/components/ExcelImporter.tsx`
- **الغرض**: واجهة المستخدم لرفع ومعاينة واستيراد الملفات
- **الميزات**:
  - رفع ملفات Excel/CSV
  - معاينة البيانات (أول 50 صف)
  - فحص جاف (Dry run) لاختبار التحقق قبل الاستيراد
  - عرض الأخطاء والتحذيرات
  - تنزيل ملف الأخطاء (CSV)
  - تنزيل قالب مثال

### 2. `src/lib/importService.ts`
- **الغرض**: معالجة منطق الاستيراد والتحقق من البيانات
- **الدوال الرئيسية**:
  - `ImportService.importRequests(rows, fileName)`: معالجة وحفظ الطلبات
  - `ImportService.generateErrorReport(result)`: إنشاء تقرير أخطاء CSV
  - `ImportService.downloadErrorFile(csv, fileName)`: تنزيل ملف الأخطاء
  - `ImportService.getImportLogs()`: الحصول على سجلات الاستيراد السابقة

## صيغة الملف (Excel/CSV)

### الأعمدة المطلوبة

#### لطلبات تراكى السفن (Type: `ship`)
| العمود | الوصف | مثال |
|--------|--------|--------|
| `Type` | نوع الطلب | `ship` |
| `VesselName` | اسم السفينة | `MV Example` |
| `ETA` | تاريخ ووقت الوصول (ISO) | `2026-02-10T08:00:00Z` |
| `BerthRequested` | النحر المطلوب | `Berth 1` |
| `ContactName` | اسم جهة الاتصال | `علي محمد` |
| `IMO` | رقم IMO للسفينة (اختياري) | `1234567` |
| `CallSign` | رمز النداء (اختياري) | `ABCD` |
| `CargoType` | نوع الحمولة (اختياري) | `General Cargo` |
| `Weight` | الوزن (اختياري) | `1000` |
| `ContactPhone` | هاتف جهة الاتصال (اختياري) | `0123456789` |
| `Notes` | ملاحظات (اختياري) | `Special handling required` |
| `Latitude` | خط العرض (اختياري) | `31.5` |
| `Longitude` | خط الطول (اختياري) | `31.8` |

#### لطلبات المخازن (Type: `warehouse`)
| العمود | الوصف | مثال |
|--------|--------|--------|
| `Type` | نوع الطلب | `warehouse` |
| `WarehouseID` | معرّف المخزن | `WH-001` |
| `StartDate` | تاريخ البدء | `2026-02-15` |
| `EndDate` | تاريخ الانتهاء | `2026-02-28` |
| `OwnerName` | اسم المالك | `الشركة العربية` |
| `GoodsType` | نوع السلع (اختياري) | `Containers` |
| `Quantity` | الكمية (اختياري) | `10` |
| `Dimensions` | الأبعاد (اختياري) | `10x10x5` |
| `OwnerPhone` | هاتف المالك (اختياري) | `0111111111` |
| `Notes` | ملاحظات (اختياري) | `Fragile items` |

### مثال CSV

```csv
Type,RequestID,VesselName,IMO,ETA,BerthRequested,CargoType,Weight,ContactName,ContactPhone,Notes
ship,,MV Example,1234567,2026-02-10T08:00:00Z,Berth 1,General,1000,علي محمد,0123456789,Special handling
warehouse,,WH-001,,,WH-001,2026-02-15,2026-02-28,Containers,10,Company X,0111111111,
```

## المخرجات والأخطاء

### نتائج الاستيراد (`ImportResult`)
```typescript
{
  success: boolean;           // هل نجح الاستيراد الكامل
  totalRows: number;          // عدد الصفوف الكلي
  successCount: number;       // عدد الصفوف الناجحة
  failedCount: number;        // عدد الصفوف الفاشلة
  errors: Array<{             // قائمة الأخطاء
    row: number;              // رقم الصف
    message: string;          // رسالة الخطأ
    data?: any;               // بيانات الصف
  }>;
  warnings: string[];         // تحذيرات (مثل أنواع غير معروفة)
  importId?: string;          // معرّف الاستيراد
  createdAt?: string;         // وقت الاستيراد
}
```

### رسائل الأخطاء الشائعة
- `"نوع الطلب (Type) مطلوب"` - العمود Type غير موجود أو فارغ
- `"اسم السفينة مطلوب (VesselName)"` - العمود VesselName فارغ
- `"تاريخ الوصول غير صحيح (ETA)"` - صيغة التاريخ غير صحيحة
- `"معرّف المخزن مطلوب (WarehouseID)"` - العمود WarehouseID فارغ

## تدفق الاستخدام

1. **اختيار الملف**: المستخدم يختار ملف Excel أو CSV
2. **المعاينة**: يتم عرض أول 50 صف من البيانات وقائمة الأعمدة
3. **فحص جاف**: يمكن تشغيل فحص بدون حفظ للتحقق من الأخطاء
4. **تصحيح الأخطاء**: إذا كانت هناك أخطاء، يمكن تنزيل تقرير وتصحيح الملف
5. **الاستيراد**: بعد نجاح الفحص الجاف، يمكن الاستيراد الفعلي
6. **النتائج**: عرض نتائج الاستيراد مع انتشار الإشعارات (toast)

## حفظ البيانات

- تُحفظ الطلبات الناجحة في `localStorage` عبر `StorageService`
- يتم إنشاء سجل استيراد في `localStorage` تحت مفتاح `port-navigator-import-logs`
- كل طلب يحصل على معرّف فريد ووقت إنشاء

## الاستثناءات والمعالجات

- يتم التعامل مع أخطاء رفع الملف برسائل خطأ واضحة
- تحويل مفاتيح الأعمدة من أشكال مختلفة (snake_case, kebab-case) إلى camelCase تلقائياً
- تحقق من صيغ التواريخ والأرقام والقيم المرجعية
- كشف الصفوف الفارغة والقيم الفارغة يتم تجاهلها

## توسعات مستقبلية

1. **معاينة خريطة**: عرض مواقع السفن على الخريطة قبل الاستيراد
2. **رفع متعدد**: دعم رفع عدة ملفات في نفس الوقت
3. **تعيين أعمدة**: السماح للمستخدم بتعيين أعمدة مخصصة
4. **استيراد مجدول**: جدولة الاستيراد على فترات منتظمة
5. **تحديث** `StorageService` ل IndexedDB للملفات الكبيرة

## الاختبار

يمكن اختبار المكوّن بإنشاء ملف CSV بسيط:

```csv
Type,VesselName,ETA,BerthRequested,ContactName
ship,Test Vessel,2026-02-15T10:00:00Z,Berth 1,Ahmed
warehouse,WH-001,2026-02-15,2026-02-28,Company A
```

ثم رفعه عبر الواجهة وملاحظة النتائج.
